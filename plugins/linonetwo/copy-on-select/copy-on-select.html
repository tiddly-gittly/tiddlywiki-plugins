<script type="application/javascript">
  // we won't do copy on select on text editor, otherwise you can't select and override text in the editor or text input
  function checkIfElementIsEditor(element) {
    if (!element || !element.nodeName) return false;
    const isEditableElement = ['INPUT', 'TEXTAREA', 'BUTTON'].includes(element.nodeName);
    if (!isEditableElement) {
      if (!element.className || !element.className.toLowerCase) return false;
    }
    const isTextEditor = element.className.toLowerCase().includes('codemirror');
    const isSlateEditor = element.dataset.slateEditor || element.dataset.slateNode || element.dataset.slateLeaf || element.dataset.slateString;

    return isEditableElement || isTextEditor || isSlateEditor;
  }
  // if we start selection on editor, we prevent the following execution of this script
  let copyOnSelectPreventCopy = false;
  /** mousedown and wait for 1s to copy */
  let copyTimeoutNotDone = true;
  /** 1s */
  const copyTimeout = 1;
  let copyTimeoutHandler = 0;
  /**
   * remove the tailing \n when copying title
   * And display a notification
   */
  const copyTextModifier = (event) => {
    event.preventDefault();
    const selection = document.getSelection();
    let copiedText = selection.toString();
    if (copiedText.endsWith('\n')) {
      copiedText = copiedText.substring(0, copiedText.length - 1);
    }
    event.clipboardData.setData('text/plain', copiedText);

    $tw.wiki.addTiddler({ title: '$:/state/notification/copy-on-select', text: `Copy\n\n${copiedText}` });
    $tw.notifier.display('$:/state/notification/copy-on-select');
    /** display copied text in notification */
    // const truncateLength = 30;
    // if (copiedText.length > truncateLength) {
    //   copiedText = `${copiedText.substring(0, 30)} ...`;
    // }
  };
  /** Copy on select, copy document selection when mouse is down for a while */
  const onCopy = () => {
    /** NodeList from root html to current element, can't get selection info. So need to use `document.execCommand('copy')` instead of copy .innerText */
    const elementsUnderMouse = document.querySelectorAll(':hover');

    const copyPrevented =
      copyTimeoutNotDone || copyOnSelectPreventCopy || !elementsUnderMouse?.length || Array.from(elementsUnderMouse).some(checkIfElementIsEditor);
    if (copyPrevented) {
      copyOnSelectPreventNextCopy = false;
      copyTimeoutNotDone = true;
      return;
    }

    document.addEventListener('copy', copyTextModifier);
    /** $tw.utils.copyToClipboard(copiedText); can't copy image or html h1 format */
    document.execCommand('copy');
    document.removeEventListener('copy', copyTextModifier);
  };

  document.addEventListener('mousedown', () => {
    const elementsUnderMouse = document.querySelectorAll(':hover');

    if (!elementsUnderMouse?.length || Array.from(elementsUnderMouse).some(checkIfElementIsEditor)) {
      copyOnSelectPreventCopy = true;
    } else {
      copyOnSelectPreventNextCopy = false;
      // if hold mouse till copyTimeout, means timeout done, then "not done" is false
      copyTimeoutNotDone = false;
      copyTimeoutHandler = setTimeout(onCopy, copyTimeout * 1000);
    }
  });

  document.addEventListener('mouseup', () => {
    copyTimeoutNotDone = true;
    clearTimeout(copyTimeoutHandler);
  });
</script>
