title: tests/scm/test-scm.js
type: application/javascript
tags: $:/tags/test-spec

/* eslint-disable @typescript-eslint/no-explicit-any */
describe('SCM Plugin Logic', function() {
  // Mock window.service and window.meta
  const mockGitOp = jasmine.createSpy('callGitOp');
  const mockGetTiddlerFilePath = jasmine.createSpy('getTiddlerFilePath');
  const mockWorkspace = { wikiFolderLocation: '/path/to/wiki' };

  beforeAll(() => {
    window.service = window.service || {};
    window.service.git = { callGitOp: mockGitOp };
    window.service.wiki = { getTiddlerFilePath: mockGetTiddlerFilePath };
    window.meta = () => ({ workspace: mockWorkspace });
  });
  
  beforeEach(() => {
     mockGitOp.calls.reset();
     mockGetTiddlerFilePath.calls.reset();
     $tw.wiki.deleteTiddler('$:/state/scm/viewing-tiddler');
     $tw.wiki.deleteTiddler('$:/temp/source-control-management/TestTiddler/commits');
  });

  it('tm-scm-reload should fetch git log and create commit tiddlers', async function() {
    // 1. Setup State
    $tw.wiki.addTiddler({ title: '$:/state/scm/viewing-tiddler', text: 'TestTiddler' });
    
    // 2. Mock API Returns
    mockGetTiddlerFilePath.and.returnValue(Promise.resolve('/path/to/wiki/tiddlers/TestTiddler.tid'));
    mockGitOp.and.returnValue(Promise.resolve({
      entries: [
        { hash: 'hash1', message: 'commit 1', author: { name: 'User' }, committerDate: '2023-01-01' },
         { hash: 'hash2', message: 'commit 2', author: { name: 'User' }, committerDate: '2023-01-02' }
      ],
      totalCount: 2
    }));

    // 3. Trigger Event
    $tw.rootWidget.dispatchEvent({ type: 'tm-scm-reload' });
    
    // 4. Wait for async operations
    await new Promise(resolve => setTimeout(resolve, 100));

    // 5. Assertions
    expect(mockGetTiddlerFilePath).toHaveBeenCalledWith('TestTiddler');
    expect(mockGitOp).toHaveBeenCalledWith('getGitLog', '/path/to/wiki', jasmine.objectContaining({
        filePath: 'tiddlers/TestTiddler.tid'
    }));

    const commitsTiddler = $tw.wiki.getTiddler('$:/temp/source-control-management/TestTiddler/commits');
    expect(commitsTiddler).toBeDefined();
    expect(commitsTiddler.fields.list).toEqual(['hash1', 'hash2']);

    const commit1 = $tw.wiki.getTiddler('$:/temp/source-control-management/TestTiddler/commit/hash1');
    expect(commit1.fields.text).toBe('commit 1');
  });

  it('tm-scm-load-files should fetch files and create file tiddlers', async function() {
     // 1. Setup State
    $tw.wiki.addTiddler({ title: '$:/state/scm/viewing-tiddler', text: 'TestTiddler' });

    // 2. Mock API
    mockGitOp.and.returnValue(Promise.resolve([
        { path: 'tiddlers/TestTiddler.tid', status: 'modified' },
        { path: 'other.txt', status: 'added' }
    ]));

    // 3. Trigger Event
    $tw.rootWidget.dispatchEvent({ type: 'tm-scm-load-files', param: 'hash1' });

    // 4. Wait
    await new Promise(resolve => setTimeout(resolve, 100));

    // 5. Assertions
    expect(mockGitOp).toHaveBeenCalledWith('getCommitFiles', '/path/to/wiki', 'hash1');

    const filesTiddler = $tw.wiki.getTiddler('$:/temp/source-control-management/TestTiddler/files');
    expect(filesTiddler).toBeDefined();
    expect(filesTiddler.fields.list.length).toBe(2);

    const file1 = $tw.wiki.getTiddler('$:/temp/source-control-management/TestTiddler/file/tiddlers%2FTestTiddler.tid');
    expect(file1).toBeDefined();
    expect(file1.fields.text).toBe('tiddlers/TestTiddler.tid');
  });
});
